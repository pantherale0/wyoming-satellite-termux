#!/data/data/com.termux/files/usr/bin/sh
. $HOME/wyoming.conf
COMMAND=""
BRANCH="main"

for i in "$@"; do
  case $i in
    --branch=*)
      BRANCH="${i#*=}"
      shift
      ;;
    --restart)
      COMMAND="RESTART"
      shift
      ;;
    --configure)
      COMMAND="CONFIGURE"
      shift
      ;;
    --disable)
      COMMAND="DISABLE"
      shift
      ;;
    --enable)
      COMMAND="ENABLE"
      shift
      ;;
    --start)
      COMMAND="START"
      shift
      ;;
    --stop)
      COMMAND="STOP"
      shift
      ;;
    --uninstall)
      COMMAND="UNINSTALL"
      shift
      ;;
    --update)
      COMMAND="UPDATE"
      shift
      ;;
    --update-cli)
      COMMAND="UPDATECLI"
      shift
      ;;
    --configure)
      COMMAND="CONFIGURE"
      shift
      ;;
    -*|--*)
      echo "Unknown option $i"
      exit 1
      ;;
    *)
      ;;
  esac
done

echo "Wyoming Android CLI: $BRANCH"

enable_services () {
  sv-enable wyoming-satellite
  sv-enable wyoming-wakeword
  sv-enable wyoming-events
  sv-enable squeezelite
}

disable_services () {
  sv-disable wyoming-satellite
  sv-disable wyoming-wakeword
  sv-disable wyoming-events
  sv-disable squeezelite
  killall python3
  killall squeezelite
}

update_service () {
  local SVC_NAME="$1"
  local SVC_RUN_FILE="$2"
  rm -f "$PREFIX/var/service/$SVC_NAME/run"
  wget "https://raw.githubusercontent.com/pantherale0/wyoming-satellite-termux/refs/heads/$BRANCH/services/$SVC_RUN_FILE" -O $PREFIX/var/service/$SVC_NAME/run
  chmod +x $PREFIX/var/service/$SVC_NAME/run
}

if [ "$COMMAND" = "RESTART" ]; then
  echo "Stopping Wyoming services"
  disable_services
  sleep 5
  echo "Starting Wyoming services"
  enable_services
  exit 0
fi

if [ "$COMMAND" = "STOP" ]; then
  echo "Stopping Wyoming services"
  disable_services
  exit 0
fi

if [ "$COMMAND" = "START" ]; then
  echo "Starting Wyoming services"
  enable_services
  exit 0
fi

if [ "$COMMAND" = "UPDATECLI" ]; then
  echo "Updating Wyoming CLI"
  rm -f $PREFIX/bin/wyoming-cli
  wget "https://raw.githubusercontent.com/pantherale0/wyoming-satellite-termux/refs/heads/$BRANCH/scripts/wyoming-cli" -O $PREFIX/bin/wyoming-cli
  chmod a+x $PREFIX/bin/wyoming-cli
fi

if [ "$COMMAND" = "UPDATE" ]; then
  echo "Updating Wyoming Components"
  echo "Disabling Wyoming"
  disable_services
  echo "Downloading Wyoming Satellite..."
  cd $HOME/wyoming-satellite
  git add wyoming_satellite/__main__.py
  git stash # keep the injected faulthander
  git pull
  git stash pop # reapply injected faulthandler
  echo "Updating Wyoming Satellite"
  ./script/setup
  echo "Wyoming Satellite updated"
  echo "Downloading Wyoming WakeWord Changes"
  cd $HOME/wyoming-openwakeword
  git pull
  echo "Updating Wyoming WakeWord"
  ./script/Setup
  echo "Wyoming WakeWord updated"
  echo "Updating Wyoming Events"
  wget "https://raw.githubusercontent.com/pantherale0/wyoming-satellite-termux/refs/heads/$BRANCH/wyoming-events.py" -O ~/wyoming-events/wyoming-events.py
  python3 -m pip install wyoming aiohttp
  echo "Wyoming Events updated"
  echo "Updating system packages"
  pkg up
  echo "Updated system packages"
  echo "Checking version information from service configuration"
  EXISTING_VERSION=$(cat $PREFIX/var/service/wyoming-satellite/run |grep -oP 'export VERSION=\d' | cut -d '=' -f2)
  if [ "$EXISTING_VERSION" = "" ]; then
    echo "Migration to wyoming.conf required... Press ctrl+C to skip"
    sleep 10
    touch $HOME/wyoming.conf
    cat $PREFIX/var/service/wyoming-satellite/run |grep -oP '^export .*=.*$'|sed "s/export //g" >> $HOME/wyoming.conf
    echo "Migrated Satellite runtime parameters"
    cat $PREFIX/var/service/wyoming-events/run |grep -oP '^export .*=.*$'|sed "s/export //g" >> $HOME/wyoming.conf
    echo "Migrated Events runtime parameters"
  fi
  echo "Pulling latest runtime scripts"
  update_service "wyoming-satellite" "wyoming-satellite-android"
  update_service "wyoming-wakeword" "wyoming-wakeword-android"
  update_service "wyoming-events" "wyoming-events-android"
  update_service "squeezelite" "squeezelite-android"
  echo "Update completed, enabling services"
  enable_services
  exit 0
fi

if [ $COMMAND = "CONFIGURE" ]; then
  disable_services
  echo "Wyoming Configuration Starting..."
  declare -a ENABLE_OPTS=($($DIALOG --clear \
	  --title "Enabled Services" \
    --checklist "Select services to enable" 15 90 5 \
            1   "Core Wyoming Satellite service." ON \
            2   "OpenWakeWord to trigger the Assist pipeline locally on device." ON \
            3   "Squeezelite to play your favourite tunes." ON \
            4   "Event forwarder to expose Wyoming Events into Home Assistant." ON 2>&1 >/dev/tty))

  for sel in "${ENABLE_OPTS[@]}"; do
    case "$sel" in
      1) ENABLE_WYOMING=1;;
      2) ENABLE_OWW=1;;
      3) ENABLE_SQUEEZELITE=1;;
      4) ENABLE_EVENTS=1;;
      *) echo "Unknown option!";;
    esac
  done
  SELECTED_WAKE_WORD=$($DIALOG --stdout --title "Wyoming Configuration" \
      --radiolist "Wakeword" 50 50 5 \
      "alexa" "Alexa" OFF \
      "ok_nabu" "Ok Nabu" ON \
      "hey_mycroft" "Hey Mycroft" OFF \
      "hey_jarvis" "Hey Jarvis" OFF \
      "hey_rhasspy" "Hey Rhasspy" OFF)
  CUSTOM_DEV_NAME=$($DIALOG --stdout --title "Wyoming Configuration" --inputbox "Enter a name for your device\nIt must not include spaces if the event forwarder is being installed\nExample: wyoming_kitchen_assistant" 15 50 "$CUSTOM_DEV_NAME")
  HASS_URL=$($DIALOG --stdout --title "Events Configuration" --inputbox "Enter the URL of your Home Assistant install" 15 50 "$HASS_URL")
  HASS_TOKEN=$($DIALOG --stdout --title "Events Configuration" --inputbox "Enter the acces token from Home Assistant\nThis can be copied into this prompt." 15 50 "$HASS_TOKEN")
  if $DIALOG --stdout --title "Autostart" \
        --backtitle "$INTERACTIVE_TITLE" \
        --yesno "Enable related services to start automatically on boot?" 7 60; then
    enable_services
  else
    $DIALOG --title "Autostart" --msgbox "You will need to start services manually" 6 44
  fi
  echo "Reconfiguration complete"
fi
